# 📋 ME.PARK 2.0 진행 현황

> **마지막 업데이트:** 2026.2.28 KST
> **마지막 작업:** 결제 구조 확정 + 매출 대시보드 설계 + SaaS 2-레이어 구조 정의

---

## 🚨 새 대화 시작 시 필독

### 현재 상태 요약
- **어드민 v3**: 11페이지 전체 완료 ✅
- **모바일 UI**: 네이비샌드위치 탭바 적용 완료 ✅ (시안A 정확 반영)
- **Part 13**: 7개 완료 ✅ (13.4는 크루앱 연계)
- **미팍티켓 DB**: 4개 테이블 생성 완료 ✅
- **CREW앱**: Phase 1~4 완료 ✅ + 실서버 버그 다수 수정
- **어드민 로그인**: admin→대시보드 직행, crew→매장선택 분기 완료 ✅
- **명칭변경**: 데이터입력 → 일일입력 완료 ✅
- **결제 구조**: 모든 매출(PG+VAN) → 미스터팍 계좌 → 주차장 정산 확정 ✅ (2026.2.28)
- **매출 대시보드**: 방안E(발행방식 기반) 3채널 통합 설계 완료 ✅ (2026.2.28)
- **SaaS 구조**: 고객사 어드민(현재) + 통합 SaaS 어드민(Phase 2) 확정 ✅ (2026.2.28)

### 다음 작업 후보 (Phase 1 완성 잔여)
1. **결제 연동** (토스페이먼츠) — 미팍티켓 PG 결제
2. **알림톡 연동** (솔라피 5종 템플릿 검수 완료)
3. **어드민 기능 연동** (미팍티켓↔대시보드 KPI 등)
4. **CREW앱 디자인 마무리**
5. **OCR 번호판 인식** — 미팍티켓 MVP 후

---

## 📊 Part 13 어드민 수정 (완료 ✅)

| Part | 항목 | 최종 | 완료일 |
|------|------|:----:|--------|
| 13.1 | 매장 설정 토글 | ✅ | 2026.2.24 |
| 13.2 | 권한 관리 시스템 | ✅ | 2026.2.23 |
| 13.3 | 알림 설정 | ✅ | 2026.2.23 |
| 13.4 | 매장 선택 화면 | — | 크루앱 연계 |
| 13.5 | 입차현황 초과 처리 | ✅ | 2026.2.24 |
| 13.6 | 추가요금 결제 | ✅ | 2026.2.24 |
| 13.7 | 퇴근 처리 요청 승인 | ✅ | 2026.2.24 |
| 13.8 | 근태 미출퇴근 집계 | ✅ | 2026.2.24 |

---

## 🎫 미팍티켓 MVP

| 기능 | 상태 | 비고 |
|------|:----:|------|
| DB 테이블 4개 | ✅ | mepark_tickets, payment_records, exit_requests, alimtalk_send_logs |
| 고객 화면 프로토타입 | ✅ | 6가지 상태 시뮬레이터 |
| QR 생성/스캔 | ❌ | |
| 토스페이먼츠 결제 | ❌ | |
| 알림톡 발송 | ❌ | 솔라피 5종 템플릿 검수 완료 |
| CREW앱 입차등록 | ❌ | |
| 매출 통합 DB (kiosk_transactions, cash_records) | ❌ | 설계 완료 (2026.2.28) |
| 매출 통합 뷰 (v_daily_revenue) | ❌ | 설계 완료 (2026.2.28) |

---

## 💰 결제/매출 구조 (2026.2.28 확정)

### 결제 흐름
```
모든 매출 → 미스터팍 계좌 → 각 주차장 정산 배분
├── PG (미팍티켓) → 토스페이먼츠 → 미스터팍 계좌
├── VAN (키오스크) → VAN사 → 미스터팍 계좌
└── 현금 → 현장 수령
```

### 매출 3채널 (방안 E: 발행방식 기반)
| 채널 | 수집 | MVP 방식 |
|------|------|---------|
| 📱 미팍티켓 | payment_records | ✅ 자동 |
| 🖥️ 키오스크 | kiosk_transactions | 📝 CREW 수동 |
| 💵 현금 | cash_records | 📝 수동 |

### 매통조 API (Phase 2)
- 여신금융협회 매통조 API → 익일 VAN+PG 통합 크로스체크
- 미스터팍 사업자번호 1개로 전 매장 조회 가능
- 등록까지 약 5~8주 (심사 포함)

---

## 📱 CREW앱

| 항목 | 상태 | 비고 |
|------|:----:|------|
| 기획서 작성 | ✅ | docs/mrpark-crew.md (2026.2.24) |
| 기본 구조 (로그인, 홈) | ✅ | Phase 1 완료 (2026.2.24) |
| 입출차 (입차등록, QR, 출차) | ✅ | Phase 2 완료 (2026.2.25) |
| 출퇴근 (출근, 퇴근직접, 수정요청) | ✅ | 퇴근=GPS직접, 수정요청=관리자 |
| 사고보고 + 월주차 조회 | ✅ | Phase 3 완료 (2026.2.25) |
| Phase 4 마무리 | ✅ | 반려강화+Toast+Realtime+로고 (2026.2.25) |

**Phase 1 완료 내역:**
- /crew 라우팅, 레이아웃, PWA manifest
- 로그인 (카카오), 매장 선택
- 홈 화면 (출근상태, 통계, 빠른메뉴, 알림)
- 출퇴근 (출근 GPS, 퇴근요청, 반려 확인, 재요청)
- 설정, 하단 네비게이션
- placeholder: 입차등록, 입차현황, 사고보고, 월주차

**접속 URL:** https://mrpark-parking.vercel.app/crew

**Phase 4 완료 내역 (A~F):**
- A: reject_reason 컬럼명 불일치 수정 (admin↔crew)
- B: Realtime 구독 — 출퇴근 페이지에서 승인/반려 즉시 감지 (새로고침 불필요)
- C: 출퇴근 상태 배너 — pending(대기), rejected(반려+사유+재요청), checkedOut(완료)
- D: CrewToast 컴포넌트 — alert() 전면 교체 (7개 페이지)
- E: 로고 변경 — ME.PARK CREW → 미팍Ticket (layout, settings, qr)
- F: 퇴근완료 카드, GPS는 미출근시만 표시

**실서버 연동 테스트 (2026.2.25):**
- ✅ 로그인(카카오) → Supabase auth + profiles + store_members 연동
- ✅ 매장선택 → stores 조회 + localStorage 저장(id+name)
- ✅ 출퇴근 → worker_attendance upsert (date, org_id 수정됨)
- ✅ 퇴근요청 → checkout_requests insert (request_reason, org_id 수정됨)
- ✅ 입차등록 → mepark_tickets insert + monthly_parking 조회
- ✅ 사고보고 → accident_reports insert + Storage 업로드
- ✅ 월주차조회 → monthly_parking 검색 (org_id 필터)
- ⚠️ 알림톡 API (/api/alimtalk/entry) 미구현 (catch로 무시됨)
- ⚠️ OCR 번호판 인식 미구현 (수동입력만, 미팍티켓 MVP 후 추가 예정)

**실서버 버그 수정 (2026.2.25):**
- ✅ Supabase RLS: stores/profiles/store_members 정책 적용 → stores는 authenticated USING(true)로 간소화
- ✅ Supabase Storage: accident-photos 버킷 + RLS 정책
- ✅ Supabase Auth: Redirect URL 추가 (이미 등록됨)
- ✅ super_admin role: getUserContext, callback, home 페이지에 추가
- ✅ stores 컬럼명: address→road_address, region→region_city
- ✅ authUser 미정의: crew/page.tsx에서 ctx.userId로 수정
- ✅ 홈 화면 로딩: 배포 완료, 테스트 필요

**실서버 버그 수정 (2026.2.26):**
- ✅ 출퇴근 GPS 현재 위치 표시 기능 추가
- ✅ 카카오 역지오코딩 연동 (/api/geocode/reverse) — Nominatim→Kakao 전환
- ✅ Vercel 환경변수 KAKAO_REST_KEY 추가, 카카오맵 API 활성화
- ✅ worker 레코드 없어도 checkLocation 호출되도록 수정
- ✅ 어드민 매장선택 페이지 컬럼명 수정 (region→region_city, address→road_address)
- ✅ super_admin/admin 출퇴근 비활성 수정 — workers 레코드 자동 생성 (attendance + home)
- ✅ 출퇴근 400/406 에러 수정 — check_in ISO→HH:MM, upsert→select+insert, single→maybeSingle
- ✅ 퇴근 플로우 변경 — 직접 퇴근(GPS) + 퇴근수정 요청(관리자에게 미처리 수정)
- ✅ 어드민 퇴근반영 개선 — 탭 진입 시 자동새로고침 + 🔄버튼 + 명칭 '퇴근수정 요청'
- 🔄 모바일에서 출퇴근 최종 테스트 필요
- ✅ toLocaleTimeString→수동 HH:MM 포맷 (브라우저 호환성 개선)
- ✅ 요청이력 페이지 CrewBottomNav 추가
- ✅ workers 조회 single()→maybeSingle() 안전화
- ✅ 카카오 로그인 느림/2번 클릭 수정 — callback page.tsx→route.ts (exchangeCodeForSession 추가)
- ✅ CREW 로그아웃→재로그인 시 어드민으로 가는 문제 — PUBLIC_PATHS + proxy.ts 활용
- ✅ 슈퍼어드민 CREW 접근 시 어드민으로 리다이렉트 — /crew 전체 public, checkAuth에 super_admin 추가
- ✅ 어드민 매장선택 PC 레이아웃 — 중앙 카드 스타일 추가
- ✅ CREW 홈 퇴근 상태 표시 — 미출근/출근중/퇴근 3상태 구분

---

## 📱 모바일 최적화 (전체 완료 ✅)

| 페이지 | 방식 | 상태 |
|--------|------|:----:|
| 대시보드 | isMobile state + CSS @media | ✅ |
| 데이터입력 | isMobile state | ✅ |
| 입차현황 | ps-desktop/ps-mobile 완전분리 | ✅ |
| 월주차 | 기존 구현 | ✅ |
| 매출분석 | an-desktop/an-mobile 완전분리 | ✅ |
| 근무자 | 기존 구현 | ✅ |
| 매장관리 | stores-desktop/mobile-view + 바텀시트모달 | ✅ |
| 팀원초대 | 기존 구현 | ✅ |
| 사고보고 | ac-table-wrap/ac-mobile-list 토글 | ✅ |
| 설정 | max-width 720px 단일컬럼 + @media | ✅ |
| 기능안내 | @media 767px 패딩/폰트 축소 | ✅ |
| 로그인 | @media 640px 모바일풀스크린↔PC카드 | ✅ |

> **세부 QA 완료 (2026.2.25):**
> - AppLayout: 인라인 padding 제거 → CSS 반응형 (PC 28/32px, 모바일 16px)
> - MobileTabBar: pb-20(80px) → pb-[120px], 아이콘 56→48px, safe-area-inset 적용
> - iOS viewport zoom 방지 (maximum-scale=1)
> - 터치 타겟 개선: parking-status X버튼(22→36), monthly 모달닫기(32→36)
> - settings toast 탭바 겹침 방지 (bottom 24→120px)
> - iOS 스크롤 모멘텀, 텍스트 사이즈 조정 방지 CSS 추가

> **디자인 통일 (2026.2.26):**
> - MobileTabBar: 시안A "네이비 샌드위치" 정확 적용 (네이비배경+골드둥근사각형 활성탭 r12)
> - AppLayout: pb-[120px] → pb-[160px] (탭바 가림 방지)
> - 대시보드: dash-bottom-row 모바일 padding-bottom 100px (월주차 카드 가려짐 해결)
> - 일일입력: compact 카드패딩, 저장버튼 safe-area 조정, overflow 수정
> - 어드민 로그인 플로우: admin→대시보드 직행, crew→매장선택 분기

---

## 🗺️ 전체 개발 로드맵 (2026.2.28 확정)

### Phase 1 — 1사업자용 완성 (현재)
| 작업 | 상태 |
|------|:----:|
| 어드민 v3 디자인 | ✅ |
| 모바일 최적화 12페이지 | ✅ |
| CREW앱 Phase 1~4 | ✅ |
| 결제 연동 (토스페이먼츠) | ❌ |
| 알림톡 연동 (솔라피 5종) | ❌ |
| 어드민 기능 연동 (미팍티켓↔KPI) | ⚠️ |
| CREW앱 디자인 마무리 | ⚠️ |

### Phase 2 — 통합 SaaS 어드민
| 작업 | 비고 |
|------|------|
| admin.mepark.kr 구축 | 별도 어드민 |
| 멀티 고객사(주차장) 관리 | org_id 확장 |
| 통합 매출/정산 대시보드 | PG+VAN 전 매장 |
| SaaS 구독/요금제 관리 | Starter~Enterprise |
| 고객사 계정 발급/온보딩 | 자동화 |
| 매통조 API 연동 | 사업자번호 1개 |
| 키오스크 Webhook 자동화 | CREW 입력 부담 제거 |

---

## 📝 작업 로그 (최근 5건)

| 날짜 | 작업 내용 | 결과 |
|------|----------|------|
| 2026.2.28 | 결제 구조 확정: 모든 매출(PG+VAN)→미스터팍 계좌→주차장 정산, BM 수수료 마진 구조 | ✅ 확정 |
| 2026.2.28 | 매출 대시보드 방안E(발행방식 기반) 설계: 미팍티켓/키오스크/현금 3채널 + 전환율 KPI | ✅ 설계완료 |
| 2026.2.28 | 3-레이어 매출 수집 구조: PG실시간+키오스크VAN+매통조 익일보정 | ✅ 설계완료 |
| 2026.2.28 | DB 설계: kiosk_transactions, cash_records, crefia_daily_summary, v_daily_revenue 뷰 | ✅ 설계완료 |
| 2026.2.28 | SaaS 2-레이어 확정: 고객사 어드민(현재) + 통합 SaaS 어드민(admin.mepark.kr, Phase 2) | ✅ 확정 |
| 2026.2.28 | 여신금융협회 매통조 API 연동 계획 수립 (Phase 2, 등록 5~8주) | ✅ 계획수립 |
| 2026.2.26 | 모바일 네이비샌드위치 디자인 적용: 하단탭바 네이비배경+골드활성탭, 상하단 통일 | ✅ 배포완료 |
| 2026.2.26 | 대시보드 하단 미정산+월주차 모바일 1열+하단여백, 어드민 로그인→대시보드 직행 | ✅ 배포완료 |
| 2026.2.26 | 일일입력 모바일최적화: compact카드패딩, 저장버튼safe-area, overflow수정, box-sizing | ✅ 배포완료 |
| 2026.2.26 | 명칭변경: 데이터입력→일일입력 (Header, Sidebar, TabBar, Guide 5곳) | ✅ 배포완료 |
| 2026.2.26 | 출퇴근 안정성 3건: toLocaleTimeString→수동HH:MM, 이력페이지 BottomNav, workers maybeSingle | ✅ 배포완료 |
| 2026.2.26 | 카카오 로그인 느림/2번클릭 수정: CREW callback page.tsx→route.ts, exchangeCodeForSession 추가, 에러메시지 | ✅ 배포완료 |
| 2026.2.26 | CREW 로그아웃→재로그인 어드민 리다이렉트 수정 + 슈퍼어드민 CREW 접근 수정 + 매장선택 PC레이아웃 | ✅ 배포완료 |
| 2026.2.27 | CREW앱 출퇴근 GPS 지도 기능: 기획서 업데이트 + GPS좌표 저장 + 카카오맵 컴포넌트 + 매장 거리 표시 + 홈 버튼 + 어드민 GPS 팝업 | 🔸 DB SQL 실행대기 + 카카오 JS키 등록 필요 |
| 2026.2.26 | CREW 홈 퇴근 상태 표시 3상태 구분 (미출근/출근중/퇴근) | ✅ 배포완료 |
| 2026.2.26 | 어드민 퇴근반영 개선: 탭진입시 자동새로고침+🔄버튼+명칭변경(퇴근수정요청) | ✅ 배포완료 |
| 2026.2.26 | 퇴근 플로우 변경: 직접퇴근(GPS)+퇴근수정요청(관리자) | ✅ 배포완료 |
| 2026.2.26 | 출퇴근 400/406 에러 수정 (check_in HH:MM, maybeSingle, select+insert 패턴) | ✅ 배포완료, 테스트 필요 |
| 2026.2.26 | super_admin/admin 출퇴근 비활성 수정 — workers 자동생성 (attendance+home) | ✅ 배포완료 |
| 2026.2.26 | 출퇴근 GPS 현재위치 주소표시 + 카카오 역지오코딩 연동 + 어드민 매장선택 컬럼명 수정 | ✅ API 작동 확인, 모바일 최종테스트 필요 |
| 2026.2.25 | CREW앱 실서버 버그수정 (super_admin role, stores 컬럼명, authUser, RLS 간소화) | ✅ 매장목록 표시 성공 |
| 2026.2.25 | Supabase 설정 (stores RLS, accident-photos 버킷, Redirect URL) | ✅ 3가지 완료 |
| 2026.2.25 | CREW앱 무한루프 수정 (getUserContext 통합, stores RLS SQL 작성) | ✅ 루프해결, RLS 실행대기 |
| 2026.2.25 | CREW앱 실서버 연동 테스트 → 7개 파일 수정 (DB컬럼 불일치/org_id누락) | ✅ 6개 이슈 수정 |
| 2026.2.25 | 모바일 세부 QA (12페이지 검수 + 6개 파일 수정) | ✅ AppLayout/TabBar/viewport/터치타겟 |
| 2026.2.25 | 모바일 미완료 7페이지 코드 검수 → 전체 이미 완료 확인 | ✅ TODO 업데이트 |
| 2026.2.25 | CREW앱 Phase 4 (반려강화, Toast, Realtime, 로고변경, 마무리) | ✅ 10개 파일 |
| 2026.2.25 | CREW앱 Phase 2 (입차등록, QR발급, 입차현황, 출차처리) | ✅ 4개 파일 |
| 2026.2.25 | CREW앱 Phase 3 (사고보고 3단계 폼, 월주차 조회) | ✅ 2개 파일 |
| 2026.2.24 | CREW앱 Phase 1 구현 (로그인, 홈, 출퇴근, 반려플로우) | ✅ 15개 파일 |
| 2026.2.24 | CREW앱 기획서 v1.0 MVP 작성 | ✅ docs/mrpark-crew.md |
| 2026.2.24 | Part 13.5 DB 실행 (mepark_tickets 등 4개 테이블) | ✅ 완료 |
| 2026.2.24 | Part 13.5 입차현황 초과 처리 코드 | ✅ 완료 |
| 2026.2.24 | Part 13.8 근태 미출퇴근 집계 확인 | ✅ 이미 구현됨 |
